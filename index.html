<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="manifest" href="manifest.json" />
  <title>ENIGMA</title>
  <style>
    :root {
      --bg: #f2f1f7;
      --card: #ffffff;
      --text: #333;
      --button: #e0e0e0;
      --win: #2ecc71;
      --loss: #e74c3c;
      --undo: #f39c12;
      --accent: #3498db;
      --chip: #f2f2f2;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #f0f0f0;
      --button: #2c2c2c;
      --chip: #2a2a2a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100%;
      overflow-x: hidden;
    }
    .container {
      max-width: 360px;
      margin: 40px auto;
      padding: 20px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: var(--bg);
      color: var(--text);
    }
    .center-box {
      background: var(--chip);
      padding: 12px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .center-box strong { color: var(--accent); }
    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .buttons button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
    }
    .buttons .win { background: var(--win); }
    .buttons .loss { background: var(--loss); }
    .buttons .undo { background: var(--undo); }
    .row {
      text-align: center;
      background: var(--chip);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .bubbles {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-bottom: 20px;
    }
    .bubble { width: 14px; height: 14px; border-radius: 50%; }
    .bubble.win { background: var(--win); }
    .bubble.loss { background: var(--loss); }
    .dark-toggle {
      position: fixed;
      top: 12px;
      right: 12px;
      font-size: 22px;
      background: transparent;
      border: none;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <button class="dark-toggle" id="themeToggle">üåô</button>
  <div class="container">
    <div class="input-group">
      <input type="number" id="ib" placeholder="Initial Balance" inputmode="decimal">
      <input type="number" id="cb" placeholder="Current Balance" inputmode="decimal">
      <input type="number" id="tad" placeholder="Total DD" inputmode="decimal">
      <input type="number" id="risk" placeholder="Risk %" value="10" inputmode="decimal" min="0">
    </div>

    <div class="center-box">
      <strong id="currentRisk">Current Risk: $0.00</strong><br>
      <small id="ddDetails">DD: $0.00 | DD Left: $0.00</small>
    </div>

    <div class="buttons">
      <button class="win" onclick="recordTrade(true)">Win</button>
      <button class="loss" onclick="recordTrade(false)">Loss</button>
      <button class="undo" onclick="undoTrade()">Undo</button>
    </div>

    <div class="row" id="streak">Streak: 0</div>
    <div class="row" id="winRate">Win Rate: 0%</div>
    <div class="bubbles" id="bubbleContainer"></div>
  </div>

  <script>
    const ib = document.getElementById("ib");
    const cb = document.getElementById("cb");
    const tad = document.getElementById("tad");
    const riskPct = document.getElementById("risk");
    const currentRisk = document.getElementById("currentRisk");
    const ddDetails = document.getElementById("ddDetails");
    const streakEl = document.getElementById("streak");
    const winRateEl = document.getElementById("winRate");
    const bubbleContainer = document.getElementById("bubbleContainer");

    let trades = JSON.parse(localStorage.getItem("trades") || "[]");

    function allFilled() {
      return ib.value !== "" && cb.value !== "" && tad.value !== "" && riskPct.value !== "";
    }
    function num(v) {
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : 0;
    }
    function fmt(n) {
      return "$" + (Number.isFinite(n) ? n.toFixed(2) : "0.00");
    }

    function updateRisk() {
      // If not all inputs are filled, show zeros and bail
      if (!allFilled()) {
        currentRisk.textContent = "Current Risk: $0.00";
        ddDetails.textContent = "DD: $0.00 | DD Left: $0.00";
        return;
      }

      const ibVal = num(ib.value);
      const cbVal = num(cb.value);
      const tadVal = Math.max(num(tad.value), 0);
      const pct = Math.max(num(riskPct.value), 0);

      // Drawdown used and left (clamped)
      const ddUsed = Math.max(ibVal - cbVal, 0);
      const ddLeft = Math.max(tadVal - ddUsed, 0);

      // Base for risk: if CB >= IB ‚Üí TAD; else ‚Üí DD Left
      const base = (cbVal >= ibVal) ? tadVal : ddLeft;
      const riskAmt = Math.max(base * (pct / 100), 0);

      currentRisk.textContent = `Current Risk: ${fmt(riskAmt)}`;
      ddDetails.textContent = `DD: ${fmt(ddUsed)} | DD Left: ${fmt(ddLeft)}`;
    }

    function recordTrade(win) {
      trades.push(win ? "win" : "loss");
      localStorage.setItem("trades", JSON.stringify(trades));
      renderBubbles();
      updateStats();
    }

    function undoTrade() {
      trades.pop();
      localStorage.setItem("trades", JSON.stringify(trades));
      renderBubbles();
      updateStats();
    }

    function renderBubbles() {
      bubbleContainer.innerHTML = "";
      trades.forEach(t => {
        const b = document.createElement("div");
        b.className = "bubble " + t;
        bubbleContainer.appendChild(b);
      });
    }

    function updateStats() {
      const wins = trades.filter(t => t === "win").length;
      const rate = trades.length ? ((wins / trades.length) * 100).toFixed(1) : 0;
      winRateEl.textContent = `Win Rate: ${rate}%`;

      let streak = 0;
      if (trades.length) {
        const last = trades[trades.length - 1];
        for (let i = trades.length - 1; i >= 0; i--) {
          if (trades[i] === last) streak++;
          else break;
        }
      }
      streakEl.textContent = `Streak: ${streak}`;
    }

    // Persist inputs and recalc
    [ib, cb, tad, riskPct].forEach(input => {
      // Load saved
      const saved = localStorage.getItem(input.id);
      if (saved !== null) input.value = saved;

      // Save on input
      input.addEventListener("input", () => {
        localStorage.setItem(input.id, input.value);
        updateRisk();
      });
    });

    // Initial paint
    updateRisk();
    renderBubbles();
    updateStats();

    // Theme toggle
    function toggleTheme() {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      document.documentElement.setAttribute("data-theme", isDark ? "light" : "dark");
      document.getElementById("themeToggle").textContent = isDark ? "üåô" : "‚òÄÔ∏è";
      localStorage.setItem("theme", isDark ? "light" : "dark");
    }
    document.getElementById("themeToggle").onclick = toggleTheme;

    // Apply saved theme
    const savedTheme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
    document.getElementById("themeToggle").textContent = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
  </script>

  <!-- Service worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("Service Worker registration failed:", err));
    }
  </script>
</body>
</html>
